/home/flomik/StudioProjects/Tempo/lib/database.dart database.dart
import 'dart:io';
import 'package:drift/drift.dart';
import 'package:drift/native.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as p;

part 'database.g.dart';

// --- Tables ---

class Activities extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text()();
  TextColumn get color => text()();
  IntColumn get sortOrder => integer().withDefault(const Constant(0))();
}

class Sessions extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get activityId => integer().references(Activities, #id, onDelete: KeyAction.cascade)();
  DateTimeColumn get startTime => dateTime()();
  DateTimeColumn get endTime => dateTime().nullable()();
}

class Tasks extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get title => text()();
  TextColumn get description => text().nullable()();
  BoolColumn get isCompleted => boolean().withDefault(const Constant(false))();
  BoolColumn get isRepeating => boolean().withDefault(const Constant(false))();
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();
  DateTimeColumn get dueDate => dateTime().nullable()();
}

// --- Database ---

@DriftDatabase(tables: [Activities, Sessions, Tasks])
class AppDatabase extends _$AppDatabase {
  AppDatabase() : super(_openConnection());

  @override
  int get schemaVersion => 1;

  @override
  MigrationStrategy get migration => MigrationStrategy(
    onCreate: (Migrator m) async {
      await m.createAll();
      await into(activities).insert(ActivitiesCompanion.insert(name: 'Coding', color: '0xFF007AFF', sortOrder: const Value(0)));
      await into(activities).insert(ActivitiesCompanion.insert(name: 'Sport', color: '0xFF34C759', sortOrder: const Value(1)));
      await into(activities).insert(ActivitiesCompanion.insert(name: 'Rest', color: '0xFFFF9500', sortOrder: const Value(2)));
    },
    beforeOpen: (details) async {
      await customStatement('PRAGMA foreign_keys = ON');
    },
  );
}

LazyDatabase _openConnection() {
  return LazyDatabase(() async {
    final dbFolder = await getApplicationDocumentsDirectory();
    final file = File(p.join(dbFolder.path, 'tempo_storage.sqlite'));
    return NativeDatabase(file);
  });
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/logic.dart logic.dart
import 'dart:async';
import 'package:drift/drift.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:tempo/database.dart';

// DB Access
final databaseProvider = Provider<AppDatabase>((ref) {
  final db = AppDatabase();
  ref.onDispose(() => db.close());
  return db;
});

// --- STORAGE ---
final sharedPreferencesProvider = Provider<SharedPreferences>((ref) {
  throw UnimplementedError();
});

// --- THEME ---
class ThemeNotifier extends StateNotifier<ThemeMode> {
  final SharedPreferences prefs;

  ThemeNotifier(this.prefs) : super(ThemeMode.system) {
    _loadTheme();
  }

  void _loadTheme() {
    final themeStr = prefs.getString('theme_mode');
    if (themeStr == 'dark') {
      state = ThemeMode.dark;
    } else if (themeStr == 'light') {
      state = ThemeMode.light;
    } else {
      state = ThemeMode.system;
    }
  }

  Future<void> setTheme(ThemeMode mode) async {
    state = mode;
    String modeStr = 'system';
    if (mode == ThemeMode.dark) modeStr = 'dark';
    if (mode == ThemeMode.light) modeStr = 'light';
    await prefs.setString('theme_mode', modeStr);
  }
}

final themeModeProvider = StateNotifierProvider<ThemeNotifier, ThemeMode>((ref) {
  final prefs = ref.watch(sharedPreferencesProvider);
  return ThemeNotifier(prefs);
});

// --- ACTIVITIES ---
final activitiesStreamProvider = StreamProvider.autoDispose<List<Activity>>((ref) {
  final db = ref.watch(databaseProvider);
  return (db.select(db.activities)..orderBy([(t) => OrderingTerm.asc(t.sortOrder)])).watch();
});

// --- TASKS FILTERS ---
enum TaskFilter { active, scheduled, repeating, done }

final tasksProvider = StreamProvider.autoDispose.family<List<Task>, TaskFilter>((ref, filter) {
  final db = ref.watch(databaseProvider);
  final query = db.select(db.tasks);

  switch (filter) {
    case TaskFilter.active:
      query.where((t) => t.isCompleted.not());
      break;
    case TaskFilter.scheduled:
      query.where((t) => t.isCompleted.not() & t.dueDate.isNotNull());
      break;
    case TaskFilter.repeating:
      query.where((t) => t.isCompleted.not() & t.isRepeating);
      break;
    case TaskFilter.done:
      query.where((t) => t.isCompleted);
      break;
  }

  return (query..orderBy([(t) => OrderingTerm.desc(t.createdAt)])).watch();
});

// --- CALENDAR ---
final selectedDateProvider = StateProvider<DateTime>((ref) => DateTime.now());

final sessionsForDateProvider = StreamProvider.autoDispose.family<List<SessionWithActivity>, DateTime>((ref, date) {
  final db = ref.watch(databaseProvider);

  // Начало текущего дня (00:00:00)
  final startOfDay = DateTime(date.year, date.month, date.day);
  // Конец текущего дня (начало следующего 00:00:00)
  final endOfDay = startOfDay.add(const Duration(days: 1));

  final query = db.select(db.sessions).join([
    leftOuterJoin(db.activities, db.activities.id.equalsExp(db.sessions.activityId))
  ])
    ..where(
      // Логика пересечения интервалов:
      // Сессия должна начаться ДО конца дня И закончиться (или еще идти) ПОСЛЕ начала дня.
        db.sessions.startTime.isSmallerThanValue(endOfDay) &
        (db.sessions.endTime.isNull() | db.sessions.endTime.isBiggerThanValue(startOfDay))
    );

  return query.watch().map((rows) {
    return rows.map((row) {
      if (row.readTableOrNull(db.activities) == null) return null;
      return SessionWithActivity(
        session: row.readTable(db.sessions),
        activity: row.readTable(db.activities),
      );
    }).whereType<SessionWithActivity>().toList();
  });
});

class SessionWithActivity {
  final Session session;
  final Activity activity;
  SessionWithActivity({required this.session, required this.activity});
}

// --- TIMER ---
final activeSessionProvider = StreamProvider.autoDispose<Session?>((ref) {
  final db = ref.watch(databaseProvider);
  return (db.select(db.sessions)..where((s) => s.endTime.isNull())).watchSingleOrNull();
});

final currentDurationProvider = Provider.autoDispose<Duration>((ref) {
  final session = ref.watch(activeSessionProvider).value;
  if (session == null) return Duration.zero;
  ref.watch(tickerProvider);
  return DateTime.now().difference(session.startTime);
});

final tickerProvider = StreamProvider.autoDispose<int>((ref) {
  return Stream.periodic(const Duration(seconds: 1), (i) => i);
});

// --- CONTROLLER ---
class AppController {
  final AppDatabase db;
  AppController(this.db);

  // Timer
  Future<void> toggleSession(int activityId) async {
    final active = await (db.select(db.sessions)..where((s) => s.endTime.isNull())).getSingleOrNull();
    if (active != null) {
      await (db.update(db.sessions)..where((s) => s.id.equals(active.id))).write(
        SessionsCompanion(endTime: Value(DateTime.now())),
      );
      if (active.activityId != activityId) await _start(activityId);
    } else {
      await _start(activityId);
    }
  }

  Future<void> stopSession() async {
    final active = await (db.select(db.sessions)..where((s) => s.endTime.isNull())).getSingleOrNull();
    if (active != null) {
      await (db.update(db.sessions)..where((s) => s.id.equals(active.id))).write(
        SessionsCompanion(endTime: Value(DateTime.now())),
      );
    }
  }

  Future<void> _start(int id) async {
    await db.into(db.sessions).insert(SessionsCompanion.insert(activityId: id, startTime: DateTime.now()));
  }

  // Activities
  Future<void> addActivity(String name, String color) async {
    await db.into(db.activities).insert(ActivitiesCompanion.insert(name: name, color: color));
  }

  Future<void> updateActivity(Activity activity) async {
    await db.update(db.activities).replace(activity);
  }

  Future<void> deleteActivity(int id) async {
    await (db.delete(db.activities)..where((a) => a.id.equals(id))).go();
  }

  // Tasks
  Future<void> toggleTask(Task task) async {
    await db.update(db.tasks).replace(task.copyWith(isCompleted: !task.isCompleted));
  }

  Future<void> deleteTask(Task task) async {
    await db.delete(db.tasks).delete(task);
  }

  Future<void> updateTask(Task task, String title, String? desc, DateTime? dueDate, bool isRepeating) async {
    await db.update(db.tasks).replace(task.copyWith(
      title: title,
      description: Value(desc),
      dueDate: Value(dueDate),
      isRepeating: isRepeating,
    ));
  }

  Future<void> addTask(String title, String? desc, DateTime? dueDate, bool isRepeating) async {
    await db.into(db.tasks).insert(TasksCompanion.insert(
      title: title,
      description: Value(desc),
      dueDate: Value(dueDate),
      isRepeating: Value(isRepeating),
    ));
  }

  // Calendar
  Future<void> addSegment(DateTime start, DateTime end, int activityId) async {
    await db.into(db.sessions).insert(SessionsCompanion.insert(
      activityId: activityId,
      startTime: start,
      endTime: Value(end),
    ));
  }

  Future<void> deleteSession(int sessionId) async {
    await (db.delete(db.sessions)..where((s) => s.id.equals(sessionId))).go();
  }

  Future<void> updateSegmentTime(int sessionId, DateTime start, DateTime end) async {
    await (db.update(db.sessions)..where((s) => s.id.equals(sessionId))).write(
      SessionsCompanion(startTime: Value(start), endTime: Value(end)),
    );
  }
}

final appControllerProvider = Provider((ref) => AppController(ref.watch(databaseProvider)));

================================================================================

/home/flomik/StudioProjects/Tempo/lib/main.dart main.dart
import 'package:adaptive_platform_ui/adaptive_platform_ui.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:shared_preferences/shared_preferences.dart'; // Добавлен импорт
import 'package:tempo/logic.dart';
import 'package:tempo/presentation/app_layout.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  // Инициализируем хранилище
  final prefs = await SharedPreferences.getInstance();

  runApp(ProviderScope(
    // Переопределяем провайдер реальным значением
    overrides: [
      sharedPreferencesProvider.overrideWithValue(prefs),
    ],
    child: const TempoApp(),
  ));
}

class TempoApp extends ConsumerWidget {
  const TempoApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Теперь это берется из SharedPreferences
    final themeMode = ref.watch(themeModeProvider);
    const primaryColor = Color(0xFF007AFF);

    return AdaptiveApp(
      title: 'Tempo',
      themeMode: themeMode,

      // Material (Android)
      materialLightTheme: ThemeData.light().copyWith(
        primaryColor: primaryColor,
        colorScheme: ColorScheme.fromSeed(seedColor: primaryColor),
      ),
      materialDarkTheme: ThemeData.dark().copyWith(
        primaryColor: primaryColor,
        colorScheme: ColorScheme.fromSeed(
          seedColor: primaryColor,
          brightness: Brightness.dark,
        ),
      ),

      // Cupertino (iOS)
      cupertinoLightTheme: const CupertinoThemeData(
        brightness: Brightness.light,
        primaryColor: primaryColor,
        scaffoldBackgroundColor: Color(0xFFF2F2F7),
        barBackgroundColor: Color(0xF0F9F9F9),
        textTheme: CupertinoTextThemeData(
          primaryColor: primaryColor,
        ),
      ),
      cupertinoDarkTheme: const CupertinoThemeData(
        brightness: Brightness.dark,
        primaryColor: primaryColor,
        scaffoldBackgroundColor: Color(0xFF000000),
        barBackgroundColor: Color(0xF01D1D1D),
        textTheme: CupertinoTextThemeData(
          primaryColor: primaryColor,
        ),
      ),

      localizationsDelegates: const [
        DefaultMaterialLocalizations.delegate,
        DefaultCupertinoLocalizations.delegate,
        DefaultWidgetsLocalizations.delegate,
      ],
      home: const AppLayout(),
    );
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/app_layout.dart app_layout.dart
import 'dart:io';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart'; // Нужен для Scaffold (материаловский) чтобы не было проблем с safearea иногда
import 'package:cupertino_native/cupertino_native.dart'; // Для CNTabBar
import 'package:tempo/presentation/views/calendar_view.dart';
import 'package:tempo/presentation/views/home_view.dart';
import 'package:tempo/presentation/views/settings_view.dart';
import 'package:tempo/presentation/views/tasks_view.dart';

class AppLayout extends StatefulWidget {
  const AppLayout({super.key});

  @override
  State<AppLayout> createState() => _AppLayoutState();
}

class _AppLayoutState extends State<AppLayout> {
  int _index = 0;

  final _pages = const [
    HomeView(),
    TasksView(),
    CalendarView(),
    Center(child: Text("Body Map (Coming Soon)")),
    SettingsView()
  ];

  @override
  Widget build(BuildContext context) {
    // Используем Stack, чтобы положить TabBar поверх контента
    // Это предотвратит его скрытие/изменение размеров при скролле
    return CupertinoPageScaffold(
      // resizeToAvoidBottomInset: false, // Опционально, если клавиатура будет мешать
      child: Stack(
        children: [
          // Контент
          Positioned.fill(
            bottom: Platform.isIOS ? 85 : 56, // Отступ под таббар (высота CNTabBar ~85 с safe area)
            child: IndexedStack(
              index: _index,
              children: _pages,
            ),
          ),

          // Таббар
          Positioned(
            left: 0,
            right: 0,
            bottom: 0,
            child: Platform.isIOS
                ? CNTabBar(
              currentIndex: _index,
              onTap: (i) => setState(() => _index = i),
              items: const [
                CNTabBarItem(label: 'Timer', icon: CNSymbol('timer')),
                CNTabBarItem(label: 'Tasks', icon: CNSymbol('checkmark.circle')),
                CNTabBarItem(label: 'Calendar', icon: CNSymbol('calendar')),
                CNTabBarItem(label: 'Body', icon: CNSymbol('person')),
                CNTabBarItem(label: 'Settings', icon: CNSymbol('gear')),
              ],
            )
                : Container( // Фолбек для Android (хотя adaptive_ui мог бы, но сделаем просто)
              color: Colors.white,
              child: BottomNavigationBar(
                currentIndex: _index,
                onTap: (i) => setState(() => _index = i),
                type: BottomNavigationBarType.fixed,
                items: const [
                  BottomNavigationBarItem(icon: Icon(Icons.timer), label: 'Timer'),
                  BottomNavigationBarItem(icon: Icon(Icons.check_circle), label: 'Tasks'),
                  BottomNavigationBarItem(icon: Icon(Icons.calendar_today), label: 'Calendar'),
                  BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Body'),
                  BottomNavigationBarItem(icon: Icon(Icons.settings), label: 'Settings'),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/widgets/app_container.dart app_container.dart
import 'package:flutter/cupertino.dart';

class AppContainer extends StatelessWidget {
  final Widget child;
  final EdgeInsetsGeometry padding;
  final VoidCallback? onTap;

  const AppContainer({
    super.key,
    required this.child,
    this.padding = const EdgeInsets.all(16),
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    // Получаем цвета, которые сами меняются при смене темы
    final backgroundColor = CupertinoColors.secondarySystemBackground.resolveFrom(context);
    final borderColor = CupertinoColors.separator.resolveFrom(context);

    final container = Container(
      padding: padding,
      decoration: BoxDecoration(
        color: backgroundColor, // В светлой теме - светло-серый, в темной - темно-серый
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: borderColor.withOpacity(0.5),
          width: 0.5,
        ),
      ),
      child: child,
    );

    if (onTap != null) {
      return GestureDetector(
        onTap: onTap,
        behavior: HitTestBehavior.opaque,
        child: container,
      );
    }

    return container;
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/screens/activity_editor_screen.dart activity_editor_screen.dart
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:tempo/database.dart';
import 'package:tempo/logic.dart';

class ActivityEditorScreen extends ConsumerStatefulWidget {
  final Activity? activity;

  const ActivityEditorScreen({super.key, this.activity});

  @override
  ConsumerState<ActivityEditorScreen> createState() => _ActivityEditorScreenState();
}

class _ActivityEditorScreenState extends ConsumerState<ActivityEditorScreen> {
  late TextEditingController _nameCtrl;
  late String _selectedColor;

  final List<String> _colors = [
    '0xFF007AFF', '0xFFFF2D55', '0xFF34C759', '0xFFFF9500',
    '0xFFAF52DE', '0xFF5856D6', '0xFF8E8E93', '0xFF000000'
  ];

  @override
  void initState() {
    super.initState();
    _nameCtrl = TextEditingController(text: widget.activity?.name ?? '');
    _selectedColor = widget.activity?.color ?? '0xFF007AFF';
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final isEditing = widget.activity != null;
    final labelColor = CupertinoColors.label.resolveFrom(context);
    final secondaryColor = CupertinoColors.secondaryLabel.resolveFrom(context);
    final bgColor = CupertinoColors.secondarySystemBackground.resolveFrom(context);

    return CupertinoPageScaffold(
      navigationBar: CupertinoNavigationBar(
        middle: Text(isEditing ? 'Edit Activity' : 'New Activity'),
        trailing: CupertinoButton(
          padding: EdgeInsets.zero,
          onPressed: _save,
          child: const Text('Save'),
        ),
      ),
      child: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text('NAME', style: TextStyle(fontSize: 13, fontWeight: FontWeight.w600, color: secondaryColor)),
              const Gap(8),
              CupertinoTextField(
                controller: _nameCtrl,
                placeholder: 'Activity Name',
                textCapitalization: TextCapitalization.words,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(12)),
              ),
              const Gap(32),
              Text('COLOR', style: TextStyle(fontSize: 13, fontWeight: FontWeight.w600, color: secondaryColor)),
              const Gap(12),
              Wrap(
                spacing: 16,
                runSpacing: 16,
                children: _colors.map((c) => GestureDetector(
                  onTap: () => setState(() => _selectedColor = c),
                  child: Container(
                    width: 44,
                    height: 44,
                    decoration: BoxDecoration(
                      color: Color(int.parse(c)),
                      shape: BoxShape.circle,
                      border: _selectedColor == c
                          ? Border.all(color: labelColor, width: 3)
                          : Border.all(color: CupertinoColors.separator.resolveFrom(context), width: 1),
                    ),
                  ),
                )).toList(),
              ),
              if (isEditing) ...[
                const Gap(60),
                SizedBox(
                  width: double.infinity,
                  child: CupertinoButton(
                    color: CupertinoColors.destructiveRed,
                    onPressed: () {
                      ref.read(appControllerProvider).deleteActivity(widget.activity!.id);
                      Navigator.pop(context);
                    },
                    child: const Text('Delete Activity', style: TextStyle(color: CupertinoColors.white)),
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  void _save() {
    if (_nameCtrl.text.trim().isEmpty) return;
    if (widget.activity == null) {
      ref.read(appControllerProvider).addActivity(_nameCtrl.text.trim(), _selectedColor);
    } else {
      ref.read(appControllerProvider).updateActivity(
          widget.activity!.copyWith(name: _nameCtrl.text.trim(), color: _selectedColor)
      );
    }
    Navigator.pop(context);
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/screens/task_editor_screen.dart task_editor_screen.dart
import 'package:adaptive_platform_ui/adaptive_platform_ui.dart'; // Только для пикеров
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:intl/intl.dart';
import 'package:tempo/database.dart';
import 'package:tempo/logic.dart';

class TaskEditorScreen extends ConsumerStatefulWidget {
  final Task? task;

  const TaskEditorScreen({super.key, this.task});

  @override
  ConsumerState<TaskEditorScreen> createState() => _TaskEditorScreenState();
}

class _TaskEditorScreenState extends ConsumerState<TaskEditorScreen> {
  late TextEditingController _titleCtrl;
  late TextEditingController _descCtrl;
  DateTime? _pickedDate;
  bool _isRepeating = false;

  @override
  void initState() {
    super.initState();
    _titleCtrl = TextEditingController(text: widget.task?.title ?? '');
    _descCtrl = TextEditingController(text: widget.task?.description ?? '');
    _pickedDate = widget.task?.dueDate;
    _isRepeating = widget.task?.isRepeating ?? false;
  }

  @override
  void dispose() {
    _titleCtrl.dispose();
    _descCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final isEditing = widget.task != null;
    final labelColor = CupertinoColors.label.resolveFrom(context);
    final secondaryColor = CupertinoColors.secondaryLabel.resolveFrom(context);
    final bgColor = CupertinoColors.secondarySystemBackground.resolveFrom(context);

    return CupertinoPageScaffold(
      navigationBar: CupertinoNavigationBar(
        middle: Text(isEditing ? 'Edit Task' : 'New Task'),
        trailing: CupertinoButton(
          padding: EdgeInsets.zero,
          onPressed: _save,
          child: const Text('Save'),
        ),
      ),
      child: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text('DETAILS', style: TextStyle(fontSize: 13, fontWeight: FontWeight.w600, color: secondaryColor)),
              const Gap(8),
              CupertinoTextField(
                controller: _titleCtrl,
                placeholder: 'Task Title',
                textCapitalization: TextCapitalization.sentences,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(10)),
              ),
              const Gap(12),
              CupertinoTextField(
                controller: _descCtrl,
                placeholder: 'Description (optional)',
                maxLines: 4,
                minLines: 4,
                textCapitalization: TextCapitalization.sentences,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(10)),
              ),

              const Gap(32),
              Text('SETTINGS', style: TextStyle(fontSize: 13, fontWeight: FontWeight.w600, color: secondaryColor)),
              const Gap(8),

              Container(
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                decoration: BoxDecoration(
                  color: bgColor,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text('Due Date', style: TextStyle(fontSize: 17, color: labelColor)),
                    CupertinoButton(
                      padding: EdgeInsets.zero,
                      minSize: 0,
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                        decoration: BoxDecoration(
                            color: CupertinoColors.tertiarySystemFill.resolveFrom(context),
                            borderRadius: BorderRadius.circular(6)
                        ),
                        child: Text(
                            _pickedDate == null ? 'Set Date' : DateFormat('MMM d').format(_pickedDate!),
                            style: TextStyle(color: CupertinoTheme.of(context).primaryColor, fontSize: 15)
                        ),
                      ),
                      onPressed: () async {
                        final date = await AdaptiveDatePicker.show(
                            context: context,
                            initialDate: _pickedDate ?? DateTime.now()
                        );
                        if (date != null) setState(() => _pickedDate = date);
                      },
                    ),
                  ],
                ),
              ),

              const Gap(12),

              Container(
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                decoration: BoxDecoration(
                  color: bgColor,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text('Repeat Daily', style: TextStyle(fontSize: 17, color: labelColor)),
                    CupertinoSwitch(
                      value: _isRepeating,
                      onChanged: (v) => setState(() => _isRepeating = v),
                    ),
                  ],
                ),
              ),

              if (isEditing) ...[
                const Gap(40),
                SizedBox(
                  width: double.infinity,
                  child: CupertinoButton(
                    color: CupertinoColors.destructiveRed,
                    onPressed: () {
                      ref.read(appControllerProvider).deleteTask(widget.task!);
                      Navigator.pop(context);
                    },
                    child: const Text('Delete Task', style: TextStyle(color: CupertinoColors.white, fontWeight: FontWeight.w600)),
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  void _save() {
    if (_titleCtrl.text.trim().isEmpty) return;

    if (widget.task == null) {
      ref.read(appControllerProvider).addTask(
        _titleCtrl.text.trim(),
        _descCtrl.text.trim(),
        _pickedDate,
        _isRepeating,
      );
    } else {
      ref.read(appControllerProvider).updateTask(
        widget.task!,
        _titleCtrl.text.trim(),
        _descCtrl.text.trim(),
        _pickedDate,
        _isRepeating,
      );
    }
    Navigator.pop(context);
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/views/calendar_view.dart calendar_view.dart
import 'dart:io';
import 'package:adaptive_platform_ui/adaptive_platform_ui.dart'; // Только для AdaptiveTimePicker
import 'package:cupertino_native/cupertino_native.dart'; // Для иконок CNSymbol
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:intl/intl.dart';
import 'package:tempo/logic.dart';

class CalendarView extends ConsumerWidget {
  const CalendarView({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final selectedDate = ref.watch(selectedDateProvider);
    final sessionsAsync = ref.watch(sessionsForDateProvider(selectedDate));
    final labelColor = CupertinoColors.label.resolveFrom(context);
    final primaryColor = CupertinoTheme.of(context).primaryColor;

    return SafeArea(
      bottom: false,
      child: Column(
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
            child: Row(
              children: [
                Text(
                    DateFormat.yMMMMd().format(selectedDate),
                    style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: labelColor)
                ),
                const Spacer(),
                CupertinoButton(
                  padding: EdgeInsets.zero,
                  child: Text("Today", style: TextStyle(color: primaryColor, fontWeight: FontWeight.w600)),
                  onPressed: () => ref.read(selectedDateProvider.notifier).state = DateTime.now(),
                ),
              ],
            ),
          ),

          // Days Ribbon
          Padding(
            padding: const EdgeInsets.symmetric(vertical: 10),
            child: SizedBox(
              height: 60,
              child: ListView.builder(
                scrollDirection: Axis.horizontal,
                itemCount: 30,
                reverse: true,
                padding: const EdgeInsets.symmetric(horizontal: 10),
                itemBuilder: (ctx, index) {
                  final date = DateTime.now().subtract(Duration(days: index));
                  final isSelected = isSameDay(date, selectedDate);
                  return GestureDetector(
                    onTap: () => ref.read(selectedDateProvider.notifier).state = date,
                    child: Container(
                      width: 50, margin: const EdgeInsets.symmetric(horizontal: 4),
                      decoration: BoxDecoration(
                        color: isSelected ? primaryColor : Colors.transparent,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Text(DateFormat.E().format(date), style: TextStyle(fontSize: 12, color: isSelected ? Colors.white : CupertinoColors.systemGrey)),
                          Text(date.day.toString(), style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: isSelected ? Colors.white : labelColor)),
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          const Divider(height: 1),

          // Timeline
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.only(bottom: 20),
              child: SizedBox(
                height: 24 * 60.0,
                child: Stack(
                  children: [
                    // Grid
                    for (int i = 0; i < 24; i++)
                      Positioned(
                        top: i * 60.0, left: 0, right: 0,
                        child: Container(
                          height: 60,
                          decoration: BoxDecoration(border: Border(top: BorderSide(color: CupertinoColors.separator.resolveFrom(context).withOpacity(0.5)))),
                          child: Padding(
                            padding: const EdgeInsets.only(left: 10, top: 5),
                            child: Text('${i.toString().padLeft(2, '0')}:00', style: const TextStyle(fontSize: 10, color: CupertinoColors.systemGrey)),
                          ),
                        ),
                      ),

                    // Tap Area
                    Positioned.fill(
                      child: GestureDetector(
                        behavior: HitTestBehavior.translucent,
                        onTapUp: (details) => _onTapEmpty(context, ref, details.localPosition.dy, selectedDate),
                        child: Container(color: Colors.transparent),
                      ),
                    ),

                    // Segments
                    sessionsAsync.when(
                      data: (items) => Stack(
                        children: items.map((item) {
                          final layout = _calculateLayout(item.session.startTime, item.session.endTime, selectedDate);
                          final color = Color(int.parse(item.activity.color));

                          return Positioned(
                            top: layout.top,
                            left: 60,
                            right: 10,
                            height: layout.height,
                            child: GestureDetector(
                              onTap: () => _showEditMenu(context, ref, item),
                              child: Container(
                                decoration: BoxDecoration(
                                  color: color.withOpacity(0.5),
                                  borderRadius: BorderRadius.circular(8),
                                  border: Border.all(color: color),
                                ),
                                padding: const EdgeInsets.all(4),
                                child: Text(item.activity.name, style: TextStyle(color: color, fontSize: 10, fontWeight: FontWeight.bold), overflow: TextOverflow.ellipsis),
                              ),
                            ),
                          );
                        }).toList(),
                      ),
                      loading: () => const SizedBox(),
                      error: (e,s) => const SizedBox(),
                    )
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Расчет позиции сегмента с учетом перехода через полночь
  ({double top, double height}) _calculateLayout(DateTime start, DateTime? end, DateTime selectedDate) {
    final effectiveEnd = end ?? DateTime.now();

    // Границы текущего дня
    final dayStart = DateTime(selectedDate.year, selectedDate.month, selectedDate.day);
    final dayEnd = dayStart.add(const Duration(days: 1));

    // Если событие вообще не попадает в этот день (например, началось и закончилось вчера, но запрос в БД вернул его по ошибке)
    if (effectiveEnd.isBefore(dayStart) || start.isAfter(dayEnd)) {
      return (top: -1000, height: 0); // Скрываем
    }

    // Обрезаем начало и конец по границам дня
    final visibleStart = start.isBefore(dayStart) ? dayStart : start;
    final visibleEnd = effectiveEnd.isAfter(dayEnd) ? dayEnd : effectiveEnd;

    final startMinutes = visibleStart.difference(dayStart).inMinutes;
    final durationMinutes = visibleEnd.difference(visibleStart).inMinutes;

    double top = startMinutes.toDouble();
    double height = durationMinutes.toDouble();

    if (height < 20) height = 20;

    return (top: top, height: height);
  }

  void _onTapEmpty(BuildContext context, WidgetRef ref, double dy, DateTime date) {
    final hour = (dy / 60).floor();
    if(hour >= 24) return;
    final tapTime = DateTime(date.year, date.month, date.day, hour);
    _showAddDialog(context, ref, tapTime);
  }

  void _showAddDialog(BuildContext context, WidgetRef ref, DateTime start) {
    final activitiesAsync = ref.read(activitiesStreamProvider);
    activitiesAsync.whenData((activities) {
      if(activities.isEmpty) return;

      showCupertinoModalPopup(
          context: context,
          builder: (_) => CupertinoActionSheet(
            title: Text('Log Activity at ${DateFormat('HH:mm').format(start)}'),
            actions: activities.map((a) => CupertinoActionSheetAction(
              onPressed: () {
                ref.read(appControllerProvider).addSegment(start, start.add(const Duration(hours: 1)), a.id);
                Navigator.pop(context);
              },
              child: Text(a.name, style: TextStyle(color: Color(int.parse(a.color)))),
            )).toList(),
            cancelButton: CupertinoActionSheetAction(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),
          )
      );
    });
  }

  // Меню действий с сегментом (Нативное меню через модалку)
  void _showEditMenu(BuildContext context, WidgetRef ref, SessionWithActivity item) {
    showCupertinoModalPopup(
        context: context,
        builder: (ctx) => CupertinoActionSheet(
          // Эмуляция нативного меню с иконками SF Symbols
          actions: [
            CupertinoActionSheetAction(
              onPressed: () { Navigator.pop(ctx); _editSegment(context, ref, item); },
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text('Edit Time'),
                  const Gap(8),
                  // Используем CNIcon для нативного SF Symbol
                  const CNIcon(symbol: CNSymbol('clock', size: 18), color: CupertinoColors.activeBlue),
                ],
              ),
            ),
            CupertinoActionSheetAction(
              isDestructiveAction: true,
              onPressed: () { Navigator.pop(ctx); ref.read(appControllerProvider).deleteSession(item.session.id); },
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text('Delete'),
                  const Gap(8),
                  const CNIcon(symbol: CNSymbol('trash', size: 18), color: CupertinoColors.destructiveRed),
                ],
              ),
            ),
          ],
          cancelButton: CupertinoActionSheetAction(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('Cancel'),
          ),
        )
    );
  }

  void _editSegment(BuildContext context, WidgetRef ref, SessionWithActivity item) {
    DateTime start = item.session.startTime;
    DateTime end = item.session.endTime ?? DateTime.now();

    showCupertinoModalPopup(
      context: context,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setState) => Material(
          color: Colors.transparent,
          child: Container(
            height: 400,
            color: CupertinoTheme.of(context).scaffoldBackgroundColor,
            padding: const EdgeInsets.all(20),
            child: Column(
              children: [
                Text("Edit Session", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: CupertinoColors.label.resolveFrom(context))),
                const Gap(20),
                _buildDateTimeRow(context, 'Start', start, (d) => setState(() => start = d)),
                const Gap(10),
                _buildDateTimeRow(context, 'End', end, (d) => setState(() => end = d)),
                const Spacer(),
                CupertinoButton.filled(
                    child: const Text('Save Changes'),
                    onPressed: () {
                      ref.read(appControllerProvider).updateSegmentTime(item.session.id, start, end);
                      Navigator.pop(ctx);
                    }
                )
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDateTimeRow(BuildContext context, String label, DateTime dt, Function(DateTime) onChanged) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(fontSize: 17)),
        Row(
          children: [
            CupertinoButton(
                padding: const EdgeInsets.symmetric(horizontal: 8),
                child: Text(DateFormat('MMM d').format(dt), style: const TextStyle(fontSize: 15)),
                onPressed: () async {
                  final date = await AdaptiveDatePicker.show(context: context, initialDate: dt);
                  if (date != null) {
                    onChanged(DateTime(date.year, date.month, date.day, dt.hour, dt.minute));
                  }
                }
            ),
            CupertinoButton(
                padding: const EdgeInsets.symmetric(horizontal: 8),
                child: Container(
                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                    decoration: BoxDecoration(
                        color: CupertinoColors.tertiarySystemFill.resolveFrom(context),
                        borderRadius: BorderRadius.circular(6)
                    ),
                    child: Text(DateFormat('HH:mm').format(dt), style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600))
                ),
                onPressed: () async {
                  final t = await AdaptiveTimePicker.show(context: context, initialTime: TimeOfDay.fromDateTime(dt));
                  if (t != null) {
                    onChanged(DateTime(dt.year, dt.month, dt.day, t.hour, t.minute));
                  }
                }
            ),
          ],
        )
      ],
    );
  }

  bool isSameDay(DateTime a, DateTime b) {
    return a.year == b.year && a.month == b.month && a.day == b.day;
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/views/tasks_view.dart tasks_view.dart
import 'package:adaptive_platform_ui/adaptive_platform_ui.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart' show Colors, Dismissible, DismissDirection, Icons;
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:intl/intl.dart';
import 'package:tempo/logic.dart';
import 'package:tempo/presentation/widgets/app_container.dart';
import 'package:tempo/presentation/screens/task_editor_screen.dart'; // Импорт нового экрана

class TasksView extends ConsumerStatefulWidget {
  const TasksView({super.key});
  @override
  ConsumerState<TasksView> createState() => _TasksViewState();
}

class _TasksViewState extends ConsumerState<TasksView> {
  TaskFilter _filter = TaskFilter.active;

  @override
  Widget build(BuildContext context) {
    final tasksAsync = ref.watch(tasksProvider(_filter));
    final labelColor = CupertinoColors.label.resolveFrom(context);

    return SafeArea(
      child: Column(
        children: [
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
            child: Row(
              children: [
                Text('Tasks', style: TextStyle(fontSize: 34, fontWeight: FontWeight.bold, color: labelColor)),
                const Spacer(),
                // Кнопка добавления ведет на новый экран
                CupertinoButton(
                  padding: EdgeInsets.zero,
                  onPressed: () => Navigator.of(context, rootNavigator: true).push(
                    CupertinoPageRoute(builder: (_) => const TaskEditorScreen()),
                  ),
                  child: const Icon(CupertinoIcons.add_circled_solid, size: 32),
                ),
              ],
            ),
          ),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20),
            child: Container(
              padding: const EdgeInsets.all(4),
              decoration: BoxDecoration(
                color: CupertinoColors.secondarySystemBackground.resolveFrom(context),
                borderRadius: BorderRadius.circular(10),
              ),
              child: SizedBox(
                width: double.infinity,
                child: CupertinoSlidingSegmentedControl<int>(
                  groupValue: _filter.index,
                  backgroundColor: Colors.transparent, // Фон берется от контейнера
                  thumbColor: CupertinoTheme.of(context).primaryColor,
                  children: {
                    for (var i = 0; i < TaskFilter.values.length; i++)
                      i: Padding(
                        padding: const EdgeInsets.symmetric(vertical: 8),
                        child: Text(
                          ['Active', 'Scheduled', 'Repeat', 'Done'][i],
                          style: TextStyle(
                              fontSize: 13,
                              color: _filter.index == i ? Colors.white : CupertinoColors.label.resolveFrom(context)
                          ),
                        ),
                      ),
                  },
                  onValueChanged: (index) {
                    if (index != null) setState(() => _filter = TaskFilter.values[index]);
                  },
                ),
              ),
            ),
          ),
          const Gap(10),
          Expanded(
            child: tasksAsync.when(
              data: (tasks) {
                if (tasks.isEmpty) return Center(child: Text("Empty", style: TextStyle(color: CupertinoColors.systemGrey.resolveFrom(context))));
                return ListView.separated(
                  padding: const EdgeInsets.fromLTRB(20, 10, 20, 100),
                  itemCount: tasks.length,
                  separatorBuilder: (_,__) => const Gap(12),
                  itemBuilder: (ctx, index) {
                    final task = tasks[index];
                    return Dismissible(
                      key: Key('${task.id}'),
                      direction: DismissDirection.endToStart,
                      onDismissed: (_) => ref.read(appControllerProvider).deleteTask(task),
                      background: Container(
                        decoration: BoxDecoration(color: CupertinoColors.destructiveRed, borderRadius: BorderRadius.circular(16)),
                        alignment: Alignment.centerRight,
                        padding: const EdgeInsets.only(right: 20),
                        child: const Icon(CupertinoIcons.trash, color: Colors.white),
                      ),
                      child: AppContainer(
                        // Нажатие открывает экран редактирования
                        onTap: () => Navigator.of(context, rootNavigator: true).push(
                          CupertinoPageRoute(builder: (_) => TaskEditorScreen(task: task)),
                        ),
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Обычная кнопка вместо нативного чекбокса
                            CupertinoButton(
                              padding: EdgeInsets.zero,
                              minSize: 0,
                              onPressed: () => ref.read(appControllerProvider).toggleTask(task),
                              child: Icon(
                                task.isCompleted ? CupertinoIcons.check_mark_circled_solid : CupertinoIcons.circle,
                                size: 24,
                                color: task.isCompleted ? CupertinoTheme.of(context).primaryColor : CupertinoColors.systemGrey3.resolveFrom(context),
                              ),
                            ),
                            const Gap(12),
                            Expanded(child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  task.title,
                                  style: TextStyle(
                                    decoration: task.isCompleted ? TextDecoration.lineThrough : null,
                                    color: task.isCompleted
                                        ? CupertinoColors.systemGrey
                                        : labelColor,
                                    fontSize: 17,
                                  ),
                                ),
                                if (task.description != null && task.description!.isNotEmpty)
                                  Text(task.description!, maxLines: 1, overflow: TextOverflow.ellipsis,
                                      style: TextStyle(fontSize: 13, color: CupertinoColors.secondaryLabel.resolveFrom(context))),

                                const Gap(4),
                                Row(
                                  children: [
                                    if (task.dueDate != null)
                                      Text(DateFormat('MMM d').format(task.dueDate!), style: const TextStyle(fontSize: 12, color: CupertinoColors.systemRed)),
                                    if (task.dueDate != null && task.isRepeating) const Gap(8),
                                    if (task.isRepeating)
                                      Icon(CupertinoIcons.repeat, size: 12, color: CupertinoColors.secondaryLabel.resolveFrom(context)),
                                  ],
                                ),
                              ],
                            )),
                          ],
                        ),
                      ),
                    );
                  },
                );
              },
              loading: () => const Center(child: CupertinoActivityIndicator()),
              error: (e,s) => Center(child: Text('Error: $e')),
            ),
          ),
        ],
      ),
    );
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/views/settings_view.dart settings_view.dart
import 'package:adaptive_platform_ui/adaptive_platform_ui.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart' show Colors, Theme, Brightness, ThemeMode;
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:tempo/logic.dart';
import 'package:tempo/presentation/widgets/app_container.dart';

class SettingsView extends ConsumerWidget {
  const SettingsView({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Определяем, включена ли темная тема РЕАЛЬНО (независимо от того, выбрано System или Dark)
    final isActuallyDark = Theme.of(context).brightness == Brightness.dark;

    final labelColor = CupertinoColors.label.resolveFrom(context);

    return SafeArea(
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
                'Settings',
                style: TextStyle(fontSize: 34, fontWeight: FontWeight.bold, color: labelColor)
            ),
            const Gap(30),
            AppContainer(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text('Dark Mode', style: TextStyle(fontSize: 17, color: labelColor)),
                  AdaptiveSwitch(
                    value: isActuallyDark,
                    activeColor: CupertinoTheme.of(context).primaryColor,
                    onChanged: (val) {
                      // Сохраняем и применяем выбор
                      ref.read(themeModeProvider.notifier).setTheme(
                          val ? ThemeMode.dark : ThemeMode.light
                      );
                    },
                  )
                ],
              ),
            ),
            const Gap(20),
            const Center(child: Text("Tempo v1.0", style: TextStyle(color: Colors.grey)))
          ],
        ),
      ),
    );
  }
}

================================================================================

/home/flomik/StudioProjects/Tempo/lib/presentation/views/home_view.dart home_view.dart
import 'dart:ui';
import 'package:adaptive_platform_ui/adaptive_platform_ui.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart' show Colors, Icons, Material, Dismissible, DismissDirection;
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:tempo/database.dart';
import 'package:tempo/logic.dart';
import 'package:tempo/presentation/widgets/app_container.dart';
import 'package:tempo/presentation/screens/activity_editor_screen.dart'; // Новый экран

class HomeView extends ConsumerWidget {
  const HomeView({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final activeSession = ref.watch(activeSessionProvider).value;
    final duration = ref.watch(currentDurationProvider);
    final activitiesAsync = ref.watch(activitiesStreamProvider);
    final labelColor = CupertinoColors.label.resolveFrom(context);
    final secondaryLabelColor = CupertinoColors.secondaryLabel.resolveFrom(context);

    return SafeArea(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          children: [
            const Gap(20),
            AppContainer(
              padding: const EdgeInsets.all(24),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text('Current Session', style: TextStyle(color: secondaryLabelColor, fontWeight: FontWeight.w500)),
                      if (activeSession != null)
                        const Icon(CupertinoIcons.bolt_fill, color: CupertinoColors.systemYellow)
                    ],
                  ),
                  const Gap(10),
                  Text(
                    _formatDuration(duration),
                    style: TextStyle(
                      fontSize: 64,
                      fontWeight: FontWeight.w200,
                      fontFeatures: const [FontFeature.tabularFigures()],
                      color: labelColor,
                    ),
                  ),
                  const Gap(24),
                  if (activeSession != null)
                    SizedBox(
                      width: double.infinity,
                      child: CupertinoButton.filled(
                        onPressed: () => ref.read(appControllerProvider).toggleSession(activeSession.activityId),
                        child: const Text('Stop Recording', style: TextStyle(fontWeight: FontWeight.w600)),
                      ),
                    )
                  else
                    Text('Choose activity to start', style: TextStyle(color: CupertinoTheme.of(context).primaryColor, fontSize: 15)),
                ],
              ),
            ),
            const Gap(40),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text('Activities', style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: labelColor)),
                CupertinoButton(
                  padding: EdgeInsets.zero,
                  onPressed: () => Navigator.of(context, rootNavigator: true).push(
                    CupertinoPageRoute(builder: (_) => const ActivitiesManagerPage()),
                  ),
                  child: const Icon(CupertinoIcons.settings, size: 24),
                ),
              ],
            ),
            const Gap(16),
            Expanded(
              child: SingleChildScrollView(
                physics: const AlwaysScrollableScrollPhysics(),
                child: activitiesAsync.when(
                  data: (activities) => Wrap(
                    spacing: 12, runSpacing: 12,
                    children: [
                      ...activities.map((act) => _ActivityChip(activity: act, isActive: activeSession?.activityId == act.id)),
                    ],
                  ),
                  loading: () => const CupertinoActivityIndicator(),
                  error: (e, s) => Text('$e'),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _formatDuration(Duration d) {
    String twoDigits(int n) => n.toString().padLeft(2, "0");
    return "${twoDigits(d.inHours)}:${twoDigits(d.inMinutes.remainder(60))}:${twoDigits(d.inSeconds.remainder(60))}";
  }
}

class _ActivityChip extends ConsumerWidget {
  final Activity activity;
  final bool isActive;
  const _ActivityChip({required this.activity, required this.isActive});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final activityColor = Color(int.parse(activity.color));

    return CupertinoButton(
      padding: EdgeInsets.zero,
      onPressed: () => ref.read(appControllerProvider).toggleSession(activity.id),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
        decoration: BoxDecoration(
          // Если активна - красим в цвет активности, если нет - в прозрачно-серый
          color: isActive ? activityColor : CupertinoColors.secondarySystemBackground.resolveFrom(context),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: isActive ? Colors.transparent : activityColor.withOpacity(0.3),
            width: 1.5,
          ),
        ),
        child: Text(
          activity.name,
          style: TextStyle(
              color: isActive ? Colors.white : activityColor,
              fontWeight: FontWeight.w600,
              fontSize: 16
          ),
        ),
      ),
    );
  }
}

// --- ACTIVITIES MANAGER PAGE ---
class ActivitiesManagerPage extends ConsumerWidget {
  const ActivitiesManagerPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final activitiesAsync = ref.watch(activitiesStreamProvider);
    final labelColor = CupertinoColors.label.resolveFrom(context);

    return CupertinoPageScaffold(
      navigationBar: CupertinoNavigationBar(
        middle: const Text('Manage Activities'),
        trailing: CupertinoButton(
          padding: EdgeInsets.zero,
          child: const Icon(CupertinoIcons.add),
          onPressed: () => Navigator.of(context).push(
            CupertinoPageRoute(builder: (_) => const ActivityEditorScreen()),
          ),
        ),
      ),
      child: SafeArea(
        child: activitiesAsync.when(
          data: (activities) {
            if (activities.isEmpty) return const Center(child: Text('No activities'));
            return ListView.separated(
              padding: const EdgeInsets.all(20),
              itemCount: activities.length,
              separatorBuilder: (_,__) => const Gap(12),
              itemBuilder: (ctx, index) {
                final act = activities[index];
                return Dismissible(
                  key: Key('act_manage_${act.id}'),
                  direction: DismissDirection.endToStart,
                  background: Container(
                    alignment: Alignment.centerRight,
                    padding: const EdgeInsets.only(right: 20),
                    decoration: BoxDecoration(color: CupertinoColors.destructiveRed, borderRadius: BorderRadius.circular(16)),
                    child: const Icon(CupertinoIcons.trash, color: Colors.white),
                  ),
                  onDismissed: (_) => ref.read(appControllerProvider).deleteActivity(act.id),
                  child: AppContainer(
                    onTap: () => Navigator.of(context).push(
                      CupertinoPageRoute(builder: (_) => ActivityEditorScreen(activity: act)),
                    ),
                    child: Row(
                      children: [
                        Container(
                            width: 20, height: 20,
                            decoration: BoxDecoration(color: Color(int.parse(act.color)), shape: BoxShape.circle)
                        ),
                        const Gap(16),
                        Expanded(child: Text(act.name, style: TextStyle(color: labelColor, fontSize: 18, fontWeight: FontWeight.w500))),
                        Icon(CupertinoIcons.chevron_right, size: 16, color: CupertinoColors.tertiaryLabel.resolveFrom(context)),
                      ],
                    ),
                  ),
                );
              },
            );
          },
          loading: () => const Center(child: CupertinoActivityIndicator()),
          error: (e,s) => Center(child: Text('$e')),
        ),
      ),
    );
  }
}

================================================================================

